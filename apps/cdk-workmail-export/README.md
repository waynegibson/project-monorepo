# cdk-workmail-export

The CDK stack includes resources to export mailbox content for an Amazon Workmail organization.

## Useful commands

The `cdk.json` file tells the CDK Toolkit how to execute your app.

- `npm run build` compile typescript to js
- `npm run watch` watch for changes and compile
- `npm run test` perform the jest unit tests
- `cdk deploy` deploy this stack to your default AWS account/region
- `cdk diff` compare deployed stack with current state
- `cdk synth` emits the synthesized CloudFormation template

## CDK option

The CDK stack will create the resources required to process mailbox exports from Amazon Workmail. The following resources are created:

- AWS Identity and Access Management (IAM) role, with a policy that grants for exporting Amazon Workmail mailboxes
- AWS KMS customer master key (CMK) associated with an S3 bucket to export AWS Workmail mailbox content.
- Encrypted S3 bucket to store zipped Amazon Workmail mailbox content.

### Configuration

The configuration file can be found at `apps/cdk-workmail-export/config`.

```typescript
import type { MailboxExportServiceProps } from '../lib/mailbox-export-service'

const config: MailboxExportServiceProps = {
  env: {
    account: '1234567890',
    region: 'eu-west-1',
  },
  organizationId: 'm-5a893d5c83c24546bf8c7e55e996f622',
  isProd: false,
}

export default config
```
Run these commands after configuration.

```bash
cdk synth && cdk list
```

```bash
cdk deploy --all
```

## CLI option

Two (2) configurable policies have been provided, and can be found in `apps/cdk-workmail-export/config/stubs` folder. Copy the two (2) files, and place them under the `apps/cdk-workmail-export/config` folder.

- mailbox-export-trust-policy.json
- mailbox-export-policy.json

Then configure the two json policy files, by replacing the placeholders with the correct information. You are then are ready to create the AWS Identity and Access Management (IAM) role, with policy grants. Then follow, the instructions below to create the `WorkmailMailboxExportRole` policy document with the CLI.

### Create Access Management (IAM) role

IAM policy that grants permission to write to the Amazon S3 bucket and encrypt the sent files with the AWS KMS customer master key (CMK).

```console
aws iam create-role --role-name WorkmailMailboxExportRole --assume-role-policy-document file://config/mailbox-export-trust-policy.json --region <REGION>
```

IAM trust policy that is attached to the IAM role you create.

```console
aws iam put-role-policy --role-name WorkmailMailboxExportRole --policy-name MailboxExport --policy-document file://config/mailbox-export-policy.json
```

### Export mailbox job

Use the AWS CLI to start the mailbox export job.

```console
aws workmail start-mailbox-export-job \
--organization-id <WORKMAIL_ORGANIZATION_ID> \
--entity-id <WORKMAIL_EMAILBOX_ID> \
--kms-key-arn <CUSTOMER_KMS_KEY_ARN> \
--role-arn <CUSTOM_ROLE_ARN> \
--s3-bucket-name <S3_BUCKET_NAME> \
--s3-prefix mailbox-export
```

### Export job monitoring

Use the AWS CLI to monitor the state of the mailbox export jobs for your Amazon WorkMail organization.

```console
aws workmail list-mailbox-export-jobs --organization-id <WORKMAIL_ORGANIZATION_ID>
```

Alternatively, use the job ID generated by the start-mailbox-export-job command to monitor the state of that mailbox export job only.

```console
aws workmail describe-mailbox-export-job --organization-id <WORKMAIL_ORGANIZATION_ID> --job-id <JOB_ID>
```

## Considerations

The following considerations apply when exporting mailbox jobs for Amazon WorkMail:

- You can run up to 10 concurrent mailbox export jobs for a given Amazon WorkMail organization.
- You can run a mailbox export job for a given mailbox as often as once every 24 hours.
- The following resources must all be in the same AWS Region:
  - Amazon WorkMail organization
  - AWS KMS CMK
  - Amazon S3 bucket

